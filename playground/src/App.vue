<script setup lang="ts">
import { onMounted, ref, toValue } from 'vue'
import { type Options, createPaymentFrame, PaymentTarget } from '@belongnet/sdk'
import { StorageSerializers, useDark, useStorage } from '@vueuse/core'
const belongPaymentRef = ref<HTMLElement | null>(null)
import isMongoId from 'validator/es/lib/isMongoId'
import isSlug from 'validator/es/lib/isSlug'

const isDark = useDark()

const state = useStorage<Options>(
  'state',
  {
    origin: undefined,
    params: {
      target: PaymentTarget.EventTicket,
      eventId: '65cca181e81ea188206cf1dc',
    },
  },
  undefined,
  {
    mergeDefaults: true,
    serializer: StorageSerializers.object,
  }
)

const errors = ref<string>()

function isCorrectId(id: string) {
  return ('' + id).length && (isMongoId(id) || isSlug(id))
}

function generatePaymentFrame() {
  errors.value = undefined

  const p = toValue(state.value.params)

  if (
    belongPaymentRef.value &&
    p.target &&
    ((p.target === PaymentTarget.EventTicket && isCorrectId(p.eventId)) ||
      (p.target === PaymentTarget.HubMinting && isCorrectId(p.hubId)))
  ) {
    try {
      return createPaymentFrame({
        el: belongPaymentRef.value,
        origin: state.value.origin,
        params:
          p.target === PaymentTarget.EventTicket
            ? {
                target: p.target,
                key: p?.key,
                eventId: p.eventId,
              }
            : {
                target: p.target,
                key: p?.key,
                hubId: p.hubId,
              },
      })
    } catch (e: any) {
      console.error(e)
      errors.value = e.message
    }
  } else {
    errors.value = 'Error: Please fill all fields correctly'
  }
}

onMounted(() => {
  generatePaymentFrame()
})
</script>

<template>
  <div class="container mx-auto">
    <main
      class="p-2 mx-auto grid grid-cols-1 md:grid-cols-2 grid-rows-[auto_1fr] md:grid-rows-1 gap-2 h-screen"
    >
      <section class="flex flex-col gap-2">
        <header class="py-4">
          <div>
            <h1 class="text-3xl font-bold">@belongnet/sdk</h1>
          </div>
        </header>

        <section>
          <input
            id="custom_origin"
            type="checkbox"
            :checked="state.origin !== undefined"
            @change="
              ($event.target as HTMLInputElement).checked
                ? (state.origin = '')
                : (state.origin = undefined)
            "
          />
          <label for="custom_origin">Enable custom origin</label><br />
          <input
            v-if="state.origin !== undefined"
            type="text"
            v-model="state.origin"
            placeholder="Enter custom Origin..."
          />
        </section>

        <section class="flex flex-col gap-2">
          <h3>Params:</h3>

          <section>
            <h4>Target:</h4>
            <input
              type="radio"
              :id="PaymentTarget.EventTicket"
              :value="PaymentTarget.EventTicket"
              v-model="state.params.target"
            />
            <label :for="PaymentTarget.EventTicket">Event Ticket</label><br />
            <input
              type="radio"
              :id="PaymentTarget.HubMinting"
              :value="PaymentTarget.HubMinting"
              v-model="state.params.target"
            />
            <label :for="PaymentTarget.HubMinting">Hub minting</label><br />
          </section>
          <section>
            <template v-if="state.params.target === PaymentTarget.EventTicket">
              <h4>Event ID:</h4>
              <input
                type="text"
                v-model="state.params.eventId"
                placeholder="Event ID"
              />
            </template>

            <template v-if="state.params.target === PaymentTarget.HubMinting">
              <h4>Hub ID:</h4>
              <input
                type="text"
                v-model="state.params.hubId"
                placeholder="Hub ID"
              />
            </template>

            <div>Enter correct <b>slug</b> or <b>id (ObjectId)</b></div>
          </section>

          <section>
            <input
              id="private_key"
              type="checkbox"
              :checked="state.params.key !== undefined"
              @change="
                ($event.target as HTMLInputElement).checked
                  ? (state.params.key = '')
                  : (state.params.key = undefined)
              "
            />
            <label for="private_key">Use private key</label><br />
            <input
              v-if="state.params.key !== undefined"
              type="text"
              v-model="state.params.key"
              placeholder="Enter Key..."
            />
          </section>
        </section>

        <section>
          <div v-show="errors" class="text-red my-2">
            {{ errors }}
          </div>

          <button @click="generatePaymentFrame()">
            Generate Payment Frame
          </button>
        </section>
      </section>

      <section class="h-full">
        <div
          class="app-frame mac wireframe borderless scrolling h-full"
          :class="isDark ? 'dark' : ''"
        >
          <div ref="belongPaymentRef"></div>
        </div>
      </section>

      <footer class="grid-col-[1/-1]">
        <div class="text-center py-4">
          <p>
            &copy; 2024 by
            <a href="https://github.com/reslear" target="_blank">reslear</a>
          </p>
        </div>
      </footer>
    </main>
  </div>
</template>

<style>
h2 {
  @apply text-2xl font-bold;
}
h3 {
  @apply text-lg font-bold;
}
h4 {
  @apply text-base font-bold;

  & + input {
    @apply mt-2;
  }
}
input[type='radio'],
input[type='checkbox'] {
  & + label {
    @apply pl-2;
  }
}

button {
  @apply text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:bg-gradient-to-l dark:focus:ring-purple-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center me-2 mb-2;
}
</style>
